WITH rst AS (
    SELECT
        dt.financetransactionid,
        premiumrefundpayment.company_code,
        pol.policyid AS pol_num,
        premiumrefundpayment.product_code AS prdt_code,
        premiumrefundpayment.baseplan_code,
        premiumrefundpayment.riderplan_code,
        premiumrefundpayment.currency,
        premiumrefundpayment.trans_currency,
        premiumrefundpayment.prem_freq,
        premiumrefundpayment.total_prem_paid,
        premiumrefundpayment.cov_num,
        premiumrefundpayment.paid_to_date,
        premiumrefundpayment.trans_code,
        premiumrefundpayment.trans_eff_date,
        premiumrefundpayment.trans_entry_date,
        premiumrefundpayment.trans_amt,
        premiumrefundpayment.account_code,
        premiumrefundpayment.acc_description,
        premiumrefundpayment.pol_issue_date,
        premiumrefundpayment.pol_incept_date,
        premiumrefundpayment.pol_eff_date,
        premiumrefundpayment.payment_date,
        premiumrefundpayment.pol_loan_num,
        premiumrefundpayment.loan_eff_date,
        premiumrefundpayment.pol_loan_amt,
        premiumrefundpayment.fund_value,
        premiumrefundpayment.cash_surrender_value,
        premiumrefundpayment.return_of_prem_value,
        premiumrefundpayment.claim_id_num,
        premiumrefundpayment.claim_status,
        premiumrefundpayment.claim_ben_codes,
        premiumrefundpayment.claim_event_date,
        premiumrefundpayment.claim_approve_date,
        premiumrefundpayment.claim_payment_date,
        premiumrefundpayment.recur_claim_flag,
        premiumrefundpayment.actual_incurred_claim,
        premiumrefundpayment.ri_claim_recoverable_id,
        premiumrefundpayment.ncb_amt,
        premiumrefundpayment.perm_discount_no_claim_discount,
        premiumrefundpayment.prem_discount_prem_refund_for_incurred_cov,
        premiumrefundpayment.prem_discount_others,
        premiumrefundpayment.prem_refund_for_remain_cov,
        premiumrefundpayment.agent_acc_value,
        premiumrefundpayment.Initial_excess_deduction,
        premiumrefundpayment.r11_company,
        premiumrefundpayment.r11_prdt,
        premiumrefundpayment.r11_prime,
        premiumrefundpayment.r11_prime_desc,
        premiumrefundpayment.r11_sub_prime,
        premiumrefundpayment.r11_expense_center,
        premiumrefundpayment.r11_afflilate,
        premiumrefundpayment.r11_ri_ind,
        premiumrefundpayment.r11_dis_channel,
        premiumrefundpayment.r11_sponsor,
        premiumrefundpayment.r12_company,
        premiumrefundpayment.r12_product,
        premiumrefundpayment.r12_prime,
        premiumrefundpayment.r12_prime_description,
        premiumrefundpayment.r12_sub_prime,
        premiumrefundpayment.r12_expense_center,
        premiumrefundpayment.r12_affiliate,
        premiumrefundpayment.r12_ri_ind,
        premiumrefundpayment.r12_location,
        premiumrefundpayment.r12_dis_channel,
        premiumrefundpayment.r12_sponsor,
        premiumrefundpayment.r12_future1,
        premiumrefundpayment.r12_future2,
        premiumrefundpayment.ri_covered,
        premiumrefundpayment.sus_acc_value,
        premiumrefundpayment.dis_channel,
        premiumrefundpayment.sponor_code,
        premiumrefundpayment.campaign_code,
        premiumrefundpayment.campaign_yr,
        premiumrefundpayment.prem_waiver_start_date,
        premiumrefundpayment.prem_waiver_end_date,
        premiumrefundpayment.prem_inv_no,
        premiumrefundpayment.source_record_id_journal_batch_name
    FROM
        (
            SELECT
                dt.financetransactionid,
                dt.sourcesystemid,
                premiumrefundpayment.company_code,
                pd.policyid,
                premiumrefundpayment.product_code,
                premiumrefundpayment.baseplan_code,
                premiumrefundpayment.riderplan_code,
                premiumrefundpayment.currency,
                premiumrefundpayment.trans_currency,
                premiumrefundpayment.prem_freq,
                premiumrefundpayment.total_prem_paid,
                premiumrefundpayment.cov_num,
                premiumrefundpayment.paid_to_date,
                premiumrefundpayment.trans_code,
                premiumrefundpayment.trans_eff_date,
                premiumrefundpayment.trans_entry_date,
                premiumrefundpayment.trans_amt,
                premiumrefundpayment.account_code,
                premiumrefundpayment.acc_description,
                premiumrefundpayment.pol_issue_date,
                premiumrefundpayment.pol_incept_date,
                premiumrefundpayment.pol_eff_date,
                premiumrefundpayment.payment_date,
                premiumrefundpayment.pol_loan_num,
                premiumrefundpayment.loan_eff_date,
                premiumrefundpayment.pol_loan_amt,
                premiumrefundpayment.fund_value,
                premiumrefundpayment.cash_surrender_value,
                premiumrefundpayment.return_of_prem_value,
                premiumrefundpayment.claim_id_num,
                premiumrefundpayment.claim_status,
                premiumrefundpayment.claim_ben_codes,
                premiumrefundpayment.claim_event_date,
                premiumrefundpayment.claim_approve_date,
                premiumrefundpayment.claim_payment_date,
                premiumrefundpayment.recur_claim_flag,
                premiumrefundpayment.actual_incurred_claim,
                premiumrefundpayment.ri_claim_recoverable_id,
                premiumrefundpayment.ncb_amt,
                premiumrefundpayment.perm_discount_no_claim_discount,
                premiumrefundpayment.prem_discount_prem_refund_for_incurred_cov,
                premiumrefundpayment.prem_discount_others,
                premiumrefundpayment.prem_refund_for_remain_cov,
                premiumrefundpayment.agent_acc_value,
                premiumrefundpayment.Initial_excess_deduction,
                premiumrefundpayment.r11_company,
                premiumrefundpayment.r11_prdt,
                premiumrefundpayment.r11_prime,
                premiumrefundpayment.r11_prime_desc,
                premiumrefundpayment.r11_sub_prime,
                premiumrefundpayment.r11_expense_center,
                premiumrefundpayment.r11_afflilate,
                premiumrefundpayment.r11_ri_ind,
                premiumrefundpayment.r11_dis_channel,
                premiumrefundpayment.r11_sponsor,
                premiumrefundpayment.r12_company,
                premiumrefundpayment.r12_product,
                premiumrefundpayment.r12_prime,
                premiumrefundpayment.r12_prime_description,
                premiumrefundpayment.r12_sub_prime,
                premiumrefundpayment.r12_expense_center,
                premiumrefundpayment.r12_affiliate,
                premiumrefundpayment.r12_ri_ind,
                premiumrefundpayment.r12_location,
                premiumrefundpayment.r12_dis_channel,
                premiumrefundpayment.r12_sponsor,
                premiumrefundpayment.r12_future1,
                premiumrefundpayment.r12_future2,
                premiumrefundpayment.ri_covered,
                premiumrefundpayment.sus_acc_value,
                premiumrefundpayment.dis_channel,
                premiumrefundpayment.sponor_code,
                premiumrefundpayment.campaign_code,
                premiumrefundpayment.campaign_yr,
                premiumrefundpayment.prem_waiver_start_date,
                premiumrefundpayment.prem_waiver_end_date,
                premiumrefundpayment.prem_inv_no,
                premiumrefundpayment.source_record_id_journal_batch_name,
                ROW_NUMBER() OVER (PARTITION BY pd.policyid ORDER BY dt.generalledgerentereddate DESC) AS rn
            FROM
                dt_financetransaction AS dt
                INNER JOIN premiumrefundpayment ON dt.financetransactionid = premiumrefundpayment.financetransactionid
                INNER JOIN policy AS pd ON dt.sourcesystemid = pd.sourcesystemid
        ) AS rst
    WHERE
        rst.rn = 1
        AND rst.company_code = '123'
        AND CONVERT(varchar(6), rst.generalledgerentereddate, 112) = '202101'
